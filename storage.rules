rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isProjectOwner(projectId) {
      return isAuthenticated() && 
        exists(/databases/(default)/documents/projects/$(projectId)) &&
        get(/databases/(default)/documents/projects/$(projectId)).data.ownerId == request.auth.uid;
    }
    
    // Project files - public read, authenticated write
    match /projects/{projectId}/{allPaths=**} {
      allow read: if true;  // Anyone can read project files
      allow write: if isAuthenticated();  // Any authenticated user can write
    }
    
    // User profile images and personal files
    match /users/{userId}/{allPaths=**} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Chat attachments - users can upload to their chat sessions
    match /chat/{sessionId}/{allPaths=**} {
      allow read, write: if isAuthenticated() &&
        exists(/databases/(default)/documents/chatSessions/$(sessionId)) &&
        isProjectOwner(get(/databases/(default)/documents/chatSessions/$(sessionId)).data.projectId);
    }
    
    // Generated content files - users can store their generated images/videos
    match /generatedContent/{userId}/{contentId}/{filename} {
      allow read: if true; // Public read for sharing generated content
      allow write: if isAuthenticated() && 
        request.auth.uid == userId &&
        // Validate file type and size
        (
          // Images: PNG, JPEG up to 10MB
          (filename.matches('.*\\.(png|jpg|jpeg)$') && resource.size < 10 * 1024 * 1024) ||
          // Videos: MP4, WEBM up to 100MB  
          (filename.matches('.*\\.(mp4|webm)$') && resource.size < 100 * 1024 * 1024)
        );
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Block all other access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
